<ui-shell>
  <content class="po-content">
    <div class="po-header">
      <div>
        <p class="eyebrow">Procurement</p>
        <h1>Purchase Orders</h1>
        <p class="subtitle">
          Track inbound stock, freight, and documents for every purchase order.
        </p>
      </div>
      <div class="actions">
        <label class="inline-control">
          <span>View archived</span>
          <input type="checkbox" [(ngModel)]="showArchived" />
        </label>
        <button class="primary" type="button" (click)="openCreateModal()">
          + New purchase order
        </button>
      </div>
    </div>

    <div class="table-wrapper" *ngIf="displayedOrders.length; else emptyState">
      <table>
        <thead>
          <tr>
            <th>PO #</th>
            <th>Vendor</th>
            <th>Recipient branch</th>
            <th>Created</th>
            <th>Expected arrival</th>
            <th>Status</th>
            <th>Tracking</th>
            <th>Total</th>
            <th>Exports</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let order of displayedOrders">
            <td>{{ order.poNumber }}</td>
            <td>{{ order.vendor }}</td>
            <td>
              <div class="stacked">
                <span>{{ order.recipientBranch }}</span>
                <small>{{ order.deliveryAddress }}</small>
              </div>
            </td>
            <td>{{ order.createdOn | date: "dd MMM yyyy" }}</td>
            <td>{{ order.expectedArrival | date: "dd MMM yyyy" }}</td>
            <td>
              <select
                [ngModel]="order.status"
                (ngModelChange)="changeStatus(order, $event)"
              >
                <option value="Ordered">Ordered</option>
                <option value="Shipping">Shipping</option>
                <option value="Shipped">Shipped</option>
                <option value="Received">Received</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </td>
            <td>
              <div class="stacked">
                <span *ngIf="order.trackingNumber; else noTracking">
                  {{ order.carrier || "Carrier TBC" }} ·
                  {{ order.trackingNumber }}
                </span>
                <ng-template #noTracking>
                  <small>Tracking not provided</small>
                </ng-template>
                <small
                  >Arrival: {{ order.expectedArrival | date: "dd MMM" }}</small
                >
              </div>
            </td>
            <td>
              {{ totalFor(order) | currency: "NZD" : "symbol" : "1.0-0" }}
            </td>
            <td class="export-actions">
              <button
                type="button"
                class="ghost"
                (click)="export(order, 'rfq')"
              >
                RFQ
              </button>
              <button type="button" class="ghost" (click)="export(order, 'po')">
                PO
              </button>
              <button
                type="button"
                class="ghost"
                (click)="export(order, 'delivery')"
              >
                Docket
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #emptyState>
      <div class="empty-state">
        <p>No purchase orders in this view yet.</p>
      </div>
    </ng-template>

    <div
      class="modal-backdrop"
      *ngIf="creationModalOpen"
      (click)="closeCreateModal()"
    >
      <div class="modal" (click)="$event.stopPropagation()">
        <header class="modal__header">
          <div>
            <p class="eyebrow">Create order</p>
            <h2>New purchase order</h2>
          </div>
          <button
            type="button"
            class="modal__close"
            aria-label="Close create form"
            (click)="closeCreateModal()"
          >
            ×
          </button>
        </header>

        <div class="modal__body">
          <div class="grid two">
            <label>
              <span>Vendor</span>
              <input
                type="text"
                [(ngModel)]="newOrder.vendor"
                placeholder="Supplier name"
              />
            </label>
            <label>
              <span>Recipient branch</span>
              <select
                [(ngModel)]="newOrder.recipientBranch"
                (change)="updateBranch(newOrder.recipientBranch)"
              >
                <option *ngFor="let branch of branches" [value]="branch">
                  {{ branch }}
                </option>
              </select>
            </label>
          </div>

          <div class="grid two">
            <label>
              <span>Delivery contact</span>
              <input type="text" [(ngModel)]="newOrder.deliveryContact" />
            </label>
            <label>
              <span>Delivery address</span>
              <input type="text" [(ngModel)]="newOrder.deliveryAddress" />
            </label>
          </div>

          <div class="grid three">
            <label>
              <span>Expected arrival</span>
              <input type="date" [(ngModel)]="newOrder.expectedArrival" />
            </label>
            <label>
              <span>Tracking number</span>
              <input
                type="text"
                [(ngModel)]="newOrder.trackingNumber"
                placeholder="Optional"
              />
            </label>
            <label>
              <span>Carrier</span>
              <select [(ngModel)]="newOrder.carrier">
                <option [ngValue]="undefined">Select carrier</option>
                <option *ngFor="let carrier of carriers" [ngValue]="carrier">
                  {{ carrier }}
                </option>
              </select>
            </label>
          </div>

          <div class="grid two">
            <label>
              <span>Status</span>
              <select [(ngModel)]="creationStatus">
                <option value="Ordered">Ordered</option>
                <option value="Shipping">Shipping</option>
                <option value="Shipped">Shipped</option>
                <option value="Received">Received</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </label>
            <label>
              <span>Branch (for reference)</span>
              <input type="text" [(ngModel)]="newOrder.branch" />
            </label>
          </div>

          <h3>Items</h3>
          <div class="line-items">
            <div
              class="line-item"
              *ngFor="let item of newOrder.items; let i = index"
            >
              <div class="line-item__main">
                <input
                  type="text"
                  [(ngModel)]="item.description"
                  (input)="searchInventory(item)"
                  placeholder="Type to search inventory or add free-text"
                />
                <div class="suggestions" *ngIf="item.suggestions?.length">
                  <button
                    type="button"
                    *ngFor="let suggestion of item.suggestions"
                    (click)="applySuggestion(item, suggestion)"
                  >
                    {{ suggestion.description }} ({{ suggestion.sku }}) ·
                    {{
                      suggestion.price | currency: "NZD" : "symbol" : "1.0-0"
                    }}
                  </button>
                  <button
                    type="button"
                    class="ghost"
                    (click)="clearSuggestions(item)"
                  >
                    Hide suggestions
                  </button>
                </div>
              </div>
              <input type="number" min="1" [(ngModel)]="item.quantity" />
              <input
                type="number"
                min="0"
                step="0.01"
                [(ngModel)]="item.price"
              />
              <span class="line-item__total">{{
                item.quantity * item.price
                  | currency: "NZD" : "symbol" : "1.0-0"
              }}</span>
              <button
                type="button"
                class="ghost"
                (click)="removeLineItem(i)"
                aria-label="Remove line"
              >
                ✕
              </button>
            </div>
          </div>
          <button class="secondary" type="button" (click)="addLineItem()">
            + Add another item
          </button>
        </div>

        <footer class="modal__actions">
          <div class="summary">
            <p>PO total</p>
            <strong>{{
              newOrderTotal | currency: "NZD" : "symbol" : "1.0-0"
            }}</strong>
          </div>
          <div class="modal__actions-buttons">
            <button
              type="button"
              class="secondary"
              (click)="closeCreateModal()"
            >
              Cancel
            </button>
            <button type="button" class="primary" (click)="createOrder()">
              Create purchase order
            </button>
          </div>
        </footer>
      </div>
    </div>
  </content>
</ui-shell>
