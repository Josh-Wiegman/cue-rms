<ui-shell>
  <content class="crew-planner">
    <header class="planner-header">
      <div>
        <h1>Crew Planner</h1>
        <p class="helper-text">
          Week-by-week view of pack-ins, shows, and pack-outs with crew and vehicle checks.
        </p>
      </div>
      <div class="week-controls">
        <button (click)="prevWeek()">⬅️ Previous</button>
        <div class="week-range">
          {{ weekRange.start | date: 'EEE d MMM' }}
          –
          {{ weekRange.end | date: 'EEE d MMM' }}
        </div>
        <button (click)="nextWeek()">Next ➡️</button>
      </div>
    </header>

    <section class="view-mode">
      <label>
        <input
          type="radio"
          name="mode"
          value="packInFirst"
          [(ngModel)]="viewMode"
        />
        Group pack-ins first
      </label>
      <label>
        <input
          type="radio"
          name="mode"
          value="chronological"
          [(ngModel)]="viewMode"
        />
        Chronological per day
      </label>
    </section>

    <section class="legend">
      <span class="pill">Pack in</span>
      <span class="pill pill-show">Show</span>
      <span class="pill pill-packout">Pack out</span>
      <span class="pill pill-warning">Crew clash</span>
      <span class="pill pill-wof">WOF alert</span>
    </section>

    <div class="week-grid">
      <div class="day-column" *ngFor="let day of weekDays">
        <div class="day-header">
          <div class="day-name">{{ day | date: 'EEEE' }}</div>
          <div class="day-date">{{ day | date: 'd MMM' }}</div>
        </div>

        <div class="day-content" *ngIf="getDayBlocks(day).length; else emptyDay">
          <article
            class="event"
            *ngFor="let item of getDayBlocks(day)"
            [class.production]="item.event.isProduction"
          >
            <header class="event-header">
              <div>
                <div class="event-title">
                  <strong>{{ item.event.salesOrder }}</strong>
                  —
                  {{ item.event.title }}
                </div>
                <div class="event-meta">
                  {{ typeLabels[item.block.type] }}
                  •
                  {{ item.block.start | date: 'shortTime' }}
                  –
                  {{ item.block.end | date: 'shortTime' }}
                </div>
              </div>
              <div class="badges">
                <span class="pill" *ngIf="item.block.type === 'pack_in'">Pack in</span>
                <span class="pill pill-packout" *ngIf="item.block.type === 'pack_out'">
                  Pack out
                </span>
                <span class="pill pill-show" *ngIf="item.block.type === 'show'">Show</span>
                <span class="pill pill-production" *ngIf="item.event.isProduction">
                  Production order
                </span>
              </div>
            </header>

            <div class="event-body">
              <div class="field">
                <label>Start</label>
                <input type="datetime-local" [(ngModel)]="item.block.start" />
              </div>
              <div class="field">
                <label>End</label>
                <input type="datetime-local" [(ngModel)]="item.block.end" />
              </div>
              <div class="field crew">
                <label>Crew for this block</label>
                <div class="crew-select">
                  <select multiple [(ngModel)]="item.block.crewIds">
                    <option *ngFor="let member of crew" [value]="member.id">
                      {{ member.name }} ({{ member.role }})
                    </option>
                  </select>
                </div>
                <div class="conflicts" *ngIf="crewConflicts(item).length">
                  <span class="pill pill-warning">Crew clash</span>
                  <span class="conflict-names">
                    {{ crewConflicts(item).join(', ') }} already allocated elsewhere
                  </span>
                </div>
              </div>
              <div class="field vehicles">
                <label>Vehicles</label>
                <div class="vehicle-list">
                  <label *ngFor="let vehicle of vehicles" class="vehicle-option">
                    <input
                      type="checkbox"
                      [checked]="item.event.assignedVehicleIds.includes(vehicle.id)"
                      (change)="toggleVehicle(item.event, vehicle.id)"
                    />
                    {{ vehicle.name }}
                  </label>
                </div>
              </div>
              <div class="field notes">
                <label>Notes</label>
                <textarea rows="2" [(ngModel)]="item.event.notes"></textarea>
              </div>
            </div>

            <div class="alerts" *ngIf="vehicleStatus(item.event, item.block.start) as vehicleStatuses">
              <div class="alert warning" *ngIf="vehicleStatuses.length">
                <span class="pill pill-wof">WOF alert</span>
                <ul>
                  <li *ngFor="let status of vehicleStatuses">
                    {{ status }} (relative to this call)
                  </li>
                </ul>
              </div>
            </div>
          </article>
        </div>

        <ng-template #emptyDay>
          <div class="empty">No events scheduled</div>
        </ng-template>
      </div>
    </div>
  </content>
</ui-shell>
