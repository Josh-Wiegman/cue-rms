<ng-container *ngIf="article$ | async as article; else loading">
  <div class="article-hero" [style.--hero-image]="article.heroImage || ''">
    <div class="hero-backdrop"></div>
    <div class="hero-content">
      <div class="breadcrumbs">{{ article.folderId }} ‚Ä∫ {{ article.tags?.join(' / ') }}</div>
      <h1>{{ article.title }}</h1>
      <p>{{ article.excerpt }}</p>
      <div class="hero-meta">
        <span>Updated {{ article.updatedAt | date: 'medium' }}</span>
        <span>Estimated {{ article.estimatedReadMins || 5 }} min read</span>
        <button class="cta" (click)="toggleFavourite(article.id)">
          {{ article.isFavourite ? '‚òÖ Favourite' : '‚òÜ Save for later' }}
        </button>
        <button class="ghost" (click)="acknowledge(article.id)">Acknowledge</button>
      </div>
      <div class="ack" *ngIf="acknowledgementMessage">{{ acknowledgementMessage }}</div>
    </div>
  </div>

  <div class="article-layout">
    <main>
      <section class="article-body" [innerHTML]="article.body"></section>

      <section class="attachments" *ngIf="article.attachments?.length">
        <h2>Attachments</h2>
        <div class="attachment-list">
          <a
            class="attachment"
            *ngFor="let attachment of article.attachments"
            [href]="attachment.url"
            target="_blank"
          >
            <span class="icon">{{ attachment.type === 'file' ? 'üìÑ' : attachment.type === 'image' ? 'üñºÔ∏è' : 'üîó' }}</span>
            <div>
              <strong>{{ attachment.name }}</strong>
              <small>{{ attachment.size ? (attachment.size / 1024 | number: '1.0-0') + ' KB' : 'External link' }}</small>
            </div>
          </a>
        </div>
      </section>

      <section class="checklist" *ngIf="article.checklist?.length">
        <h2>Checklist</h2>
        <label *ngFor="let item of article.checklist">
          <input type="checkbox" (change)="completeChecklist(article.id, item.id, $event.target.checked)" />
          {{ item.label }}
        </label>
      </section>

      <section class="quiz" *ngIf="quiz$ | async as quiz">
        <h2>{{ quiz.title }}</h2>
        <p>{{ quiz.summary }}</p>
        <form (ngSubmit)="submitQuiz(article.id, quiz.id)" [formGroup]="quizForm">
          <div class="quiz-question" *ngFor="let question of quiz.questions">
            <h3>{{ question.prompt }}</h3>
            <ng-container [ngSwitch]="question.type">
              <ng-container *ngSwitchCase="'single'">
                <label *ngFor="let choice of question.choices">
                  <input type="radio" [value]="choice.id" [formControlName]="question.id" />
                  {{ choice.label }}
                </label>
              </ng-container>
              <ng-container *ngSwitchCase="'multi'">
                <label *ngFor="let choice of question.choices">
                  <input
                    type="checkbox"
                    [checked]="(quizForm.get(question.id)?.value || []).includes(choice.id)"
                    (change)="toggleMulti(question.id, choice.id, $event.target.checked)"
                  />
                  {{ choice.label }}
                </label>
              </ng-container>
              <ng-container *ngSwitchCase="'true_false'">
                <select [formControlName]="question.id">
                  <option [ngValue]="true">True</option>
                  <option [ngValue]="false">False</option>
                </select>
              </ng-container>
              <ng-container *ngSwitchCase="'short_text'">
                <textarea [formControlName]="question.id"></textarea>
              </ng-container>
            </ng-container>
          </div>
          <button class="cta" type="submit" [disabled]="submittingQuiz">Submit quiz</button>
        </form>
      </section>

      <section class="comments">
        <h2>Discussion</h2>
        <div class="comment" *ngFor="let comment of article.comments; trackBy: trackByComment">
          <div class="avatar">{{ comment.authorName[0] }}</div>
          <div class="comment-body">
            <header>
              <strong>{{ comment.authorName }}</strong>
              <span>{{ comment.createdAt | date: 'short' }}</span>
            </header>
            <p>{{ comment.body }}</p>
            <div class="mentions" *ngIf="comment.mentions?.length">
              <span *ngFor="let mention of comment.mentions">@{{ mention }}</span>
            </div>
          </div>
        </div>

        <form class="comment-form" [formGroup]="commentForm" (ngSubmit)="submitComment(article)">
          <textarea
            placeholder="Share an insight, ask a question, or @mention a teammate"
            formControlName="body"
          ></textarea>
          <button type="submit" class="cta" [disabled]="submittingComment">Post comment</button>
        </form>
      </section>
    </main>

    <aside>
      <section class="release" *ngIf="article.releaseRule as rule">
        <h3>Release rules</h3>
        <ul>
          <li *ngIf="rule.sequenceIndex as order">Part of sequence #{{ order + 1 }}</li>
          <li *ngIf="rule.requiresArticles?.length as acount">
            Requires {{ acount }} article(s) first
          </li>
          <li *ngIf="rule.requiresQuizzes?.length as qcount">
            Requires {{ qcount }} quiz(es)
          </li>
        </ul>
      </section>

      <section class="related" *ngIf="(relatedArticles$ | async)?.length as total">
        <h3>Related articles</h3>
        <a *ngFor="let related of (relatedArticles$ | async)" [routerLink]="['/kb/article', related.slug || related.id]">
          {{ related.title }}
        </a>
      </section>
    </aside>
  </div>
</ng-container>

<ng-template #loading>
  <div class="loading">Loading article‚Ä¶</div>
</ng-template>
