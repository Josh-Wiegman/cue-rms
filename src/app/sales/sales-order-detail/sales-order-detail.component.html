<ui-shell>
  <content class="order-detail" *ngIf="order as current">
    <div class="breadcrumb">
      <a routerLink="/sales">Sales Orders</a>
      <span>/</span>
      <span class="crumb">{{ current.orderNumber }}</span>
    </div>

    <header class="order-header">
      <div>
        <p class="eyebrow">{{ current.orderType }}</p>
        <h1>{{ current.title }}</h1>
        <p class="meta">{{ current.orderNumber }} ¬∑ {{ current.status }}</p>
        <div class="tags">
          <span *ngFor="let tag of current.tags">{{ tag }}</span>
        </div>
      </div>
      <div class="totals">
        <div>
          <p class="label">Total excl. GST</p>
          <p class="value">
            {{ totalExcl | currency: "NZD" : "symbol" : "1.0-0" }}
          </p>
        </div>
        <div>
          <p class="label">Total incl. GST</p>
          <p class="value">
            {{ totalIncl | currency: "NZD" : "symbol" : "1.0-0" }}
          </p>
        </div>
        <button type="button" class="primary" (click)="updateOrder()">
          Save order
        </button>
      </div>
    </header>

    <section class="order-grid">
      <div class="card">
        <div class="card-heading">
          <h3>Schedule</h3>
          <button
            type="button"
            class="edit-button"
            (click)="openEdit('schedule')"
          >
            Edit
          </button>
        </div>
        <dl>
          <div>
            <dt>Start date</dt>
            <dd>{{ current.startDate | date: "dd MMM yyyy" }}</dd>
          </div>
          <div>
            <dt>End date</dt>
            <dd>{{ current.endDate | date: "dd MMM yyyy" }}</dd>
          </div>
          <div>
            <dt>Billable days</dt>
            <dd>
              <input
                type="number"
                min="1"
                [ngModel]="current.billableDays"
                (ngModelChange)="updateBillableDays($event)"
              />
            </dd>
          </div>
          <div>
            <dt>Rental period</dt>
            <dd>{{ current.rentalPeriodDays }} days</dd>
          </div>
        </dl>
      </div>

      <div class="card">
        <div class="card-heading">
          <h3>Customer</h3>
          <button
            type="button"
            class="edit-button"
            (click)="openEdit('customer')"
          >
            Edit
          </button>
        </div>
        <dl>
          <div>
            <dt>Customer</dt>
            <dd>{{ current.customer }}</dd>
          </div>
          <div>
            <dt>Delivery location</dt>
            <dd>{{ current.deliveryLocation }}</dd>
          </div>
          <div>
            <dt>Service branch</dt>
            <dd>{{ current.serviceBranch }}</dd>
          </div>
          <div>
            <dt>Status</dt>
            <dd>{{ current.status }} / {{ current.warehouseStatus }}</dd>
          </div>
        </dl>
      </div>

      <div class="card">
        <div class="card-heading">
          <h3>Financial</h3>
          <button
            type="button"
            class="edit-button"
            (click)="openEdit('financial')"
          >
            Edit
          </button>
        </div>
        <dl>
          <div>
            <dt>Global discount</dt>
            <dd>
              <select
                [ngModel]="current.globalDiscount?.type"
                (ngModelChange)="
                  current.globalDiscount = current.globalDiscount || {
                    type: 'percent',
                    value: 0,
                  }
                "
              >
                <option value="percent">% off subtotal</option>
                <option value="amount">$ off subtotal</option>
              </select>
              <input
                type="number"
                min="0"
                [(ngModel)]="current.globalDiscount!.value"
              />
            </dd>
          </div>
          <div>
            <dt>Customer reference</dt>
            <dd>{{ current.customerReference }}</dd>
          </div>
          <div>
            <dt>Internal reference</dt>
            <dd>{{ current.internalReference }}</dd>
          </div>
          <div>
            <dt>Total discount</dt>
            <dd>
              {{ totalDiscountValue | currency: "NZD" : "symbol" : "1.0-0" }}
            </dd>
          </div>
        </dl>
      </div>
    </section>

    <section class="stock">
      <div class="stock-header">
        <div>
          <h2>Stock list</h2>
          <p class="subtitle">
            Group items, add subgroups, and use the picker to drop new items
            into the correct section.
          </p>
        </div>
        <button type="button" class="secondary" (click)="addGroup()">
          + Add top-level group
        </button>
      </div>

      <ng-template #groupTemplate let-group>
        <div class="group">
          <div class="group-header">
            <input class="group-title" [(ngModel)]="group.title" />
            <div class="group-actions">
              <button type="button" (click)="addGroup(group.id)">
                + Subgroup
              </button>
              <button type="button" class="quiet-button" (click)="removeGroup(group.id)">
                Delete
              </button>
              <button
                type="button"
                class="quiet-button"
                (click)="openPicker(group.id)"
                aria-label="Open item picker"
              >
                üîç Show picker
              </button>
            </div>
          </div>

          <div
            class="items"
            (dragover)="onDragOver($event)"
            (drop)="onDrop($event, group.id)"
          >
            <div class="item-grid-header">
              <span class="center">Move</span>
              <span>Item</span>
              <span class="center">Qty</span>
              <span class="center">Days</span>
              <span class="center">Discount</span>
              <span class="right">Price</span>
              <span class="sr-only">Actions</span>
            </div>
            <div
              class="item"
              *ngFor="let item of group.items; let i = index"
              draggable="true"
              [class.dragging]="isDraggingItem(item.id)"
              (dragstart)="startDrag(group.id, item.id)"
              (dragend)="endDrag()"
              (dragover)="onDragOver($event)"
              (drop)="onDrop($event, group.id, i)"
            >
              <div class="drag-handle" title="Drag to reorder">
                ‚ò∞
              </div>
              <div>
                <p class="item-name">{{ item.name }}</p>
                <p class="item-meta">{{ item.sku }}</p>
              </div>
              <div class="item-cell">
                <input
                  type="number"
                  min="1"
                  [ngModel]="item.quantity"
                  (ngModelChange)="updateItemQuantity(item, $event)"
                />
              </div>
              <div class="item-cell">
                <input
                  type="number"
                  min="1"
                  [ngModel]="item.billableDays"
                  (ngModelChange)="updateItemBillableDays(item, $event)"
                  [placeholder]="order?.billableDays?.toString()"
                />
              </div>
              <div class="item-cell discount">
                <select
                  [ngModel]="item.discount?.type || ''"
                  (ngModelChange)="setItemDiscountType(item, $event)"
                >
                  <option value="">None</option>
                  <option value="percent">%</option>
                  <option value="amount">$</option>
                </select>
                <input
                  type="number"
                  min="0"
                  [ngModel]="item.discount?.value"
                  (ngModelChange)="updateItemDiscountValue(item, $event)"
                  [disabled]="!item.discount"
                  placeholder="0"
                />
              </div>
              <p class="item-total">
                {{ itemPrice(item) | currency: "NZD" : "symbol" : "1.0-0" }}
              </p>
              <button
                type="button"
                class="icon-button"
                aria-label="Remove item"
                (click)="removeItem(group.id, item.id)"
              >
                ‚úï
              </button>
            </div>
            <div *ngIf="!group.items.length" class="empty-items">
              Drop items here or use the picker.
            </div>
          </div>

          <div class="children" *ngIf="group.groups.length">
            <ng-container
              *ngFor="let child of group.groups"
              [ngTemplateOutlet]="groupTemplate"
              [ngTemplateOutletContext]="{ $implicit: child }"
            ></ng-container>
          </div>
        </div>
      </ng-template>

      <div class="group-list" *ngIf="current.groups.length; else noGroups">
        <ng-container
          *ngFor="let group of current.groups"
          [ngTemplateOutlet]="groupTemplate"
          [ngTemplateOutletContext]="{ $implicit: group }"
        ></ng-container>
      </div>
      <ng-template #noGroups>
        <div class="empty-state">
          <p>No groups yet. Create one to begin building the stock list.</p>
        </div>
      </ng-template>
    </section>
    <div
      class="modal-backdrop"
      *ngIf="pickerModal.open"
      (click)="closePicker()"
    >
      <div class="modal picker-modal" (click)="$event.stopPropagation()">
        <header class="modal-header">
          <p class="eyebrow">Add items to group</p>
          <button type="button" class="close" (click)="closePicker()">√ó</button>
        </header>

        <div class="picker-modal__controls">
          <input
            type="search"
            placeholder="Search items"
            [(ngModel)]="pickerModal.search"
          />
          <small>Showing up to 30 results</small>
        </div>

        <div class="picker-modal__body">
          <div class="picker-list">
            <button
              class="picker-item"
              type="button"
              *ngFor="let item of filteredLibrary()"
              [class.selected]="isSelected(item.id)"
              (click)="toggleSelection(item)"
            >
              <div>
                <p class="item-name">{{ item.name }}</p>
                <p class="item-meta">{{ item.sku }}</p>
              </div>
              <span
                >{{
                  item.rates.oneDay | currency: "NZD" : "symbol" : "1.0-0"
                }}
                / day</span
              >
            </button>
          </div>

          <div class="picker-selections">
            <div class="picker-selections__heading">
              <h4>Selected items</h4>
              <span class="badge">{{ pickerSelections.length }}</span>
            </div>
            <div *ngIf="!pickerSelections.length" class="empty-state compact">
              Choose items to set quantities before adding.
            </div>
            <div
              class="selection-row"
              *ngFor="let selection of pickerSelections"
            >
              <div>
                <p class="item-name">{{ selection.item.name }}</p>
                <p class="item-meta">{{ selection.item.sku }}</p>
              </div>
              <label>
                <span>Qty</span>
                <input
                  type="number"
                  min="1"
                  [ngModel]="selection.quantity"
                  (ngModelChange)="
                    updateSelectionQuantity(selection.item.id, $event)
                  "
                />
              </label>
            </div>
          </div>
        </div>

        <footer class="modal-actions">
          <button type="button" class="secondary" (click)="closePicker()">
            Cancel
          </button>
          <button
            type="button"
            class="primary"
            [disabled]="!pickerSelections.length"
            (click)="confirmPicker()"
          >
            Add to group
          </button>
        </footer>
      </div>
    </div>
    <div class="modal-backdrop" *ngIf="activeEdit" (click)="closeEdit()">
      <div class="modal" (click)="$event.stopPropagation()">
        <header class="modal-header">
          <p class="eyebrow">Update {{ activeEdit }} info</p>
          <button type="button" class="close" (click)="closeEdit()">√ó</button>
        </header>

        <div class="modal-body" [ngSwitch]="activeEdit">
          <ng-container *ngSwitchCase="'schedule'">
            <label>
              <span>Start date</span>
              <input type="date" [(ngModel)]="draftSchedule.startDate" />
            </label>
            <label>
              <span>End date</span>
              <input type="date" [(ngModel)]="draftSchedule.endDate" />
            </label>
            <label>
              <span>Billable days</span>
              <input
                type="number"
                min="1"
                [(ngModel)]="draftSchedule.billableDays"
              />
            </label>
            <label>
              <span>Rental period (days)</span>
              <input
                type="number"
                min="1"
                [(ngModel)]="draftSchedule.rentalPeriodDays"
              />
            </label>
          </ng-container>

          <ng-container *ngSwitchCase="'customer'">
            <label>
              <span>Customer</span>
              <input type="text" [(ngModel)]="draftCustomer.customer" />
            </label>
            <label>
              <span>Delivery location</span>
              <input type="text" [(ngModel)]="draftCustomer.deliveryLocation" />
            </label>
            <label>
              <span>Service branch</span>
              <input type="text" [(ngModel)]="draftCustomer.serviceBranch" />
            </label>
            <label>
              <span>Order type</span>
              <select [(ngModel)]="draftCustomer.orderType">
                <option value="Production">Production</option>
                <option value="Dry Hire">Dry Hire</option>
                <option value="Stock Transfer">Stock Transfer</option>
              </select>
            </label>
            <label>
              <span>Status</span>
              <select [(ngModel)]="draftCustomer.status">
                <option value="Quote">Quote</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Invoiced">Invoiced</option>
                <option value="Completed">Completed</option>
                <option value="Dead">Dead</option>
              </select>
            </label>
            <label>
              <span>Warehouse status</span>
              <select [(ngModel)]="draftCustomer.warehouseStatus">
                <option value="To Prep">To Prep</option>
                <option value="Prepped">Prepped</option>
                <option value="Loaded">Loaded</option>
                <option value="With Client">With Client</option>
                <option value="Returned">Returned</option>
                <option value="Partial Return">Partial Return</option>
                <option value="Completed">Completed</option>
              </select>
            </label>
            <label>
              <span>Tags</span>
              <input
                type="text"
                [(ngModel)]="draftCustomer.tags"
                placeholder="Comma separated"
              />
            </label>
          </ng-container>

          <ng-container *ngSwitchCase="'financial'">
            <label>
              <span>Global discount type</span>
              <select [(ngModel)]="draftFinancial.globalDiscountType">
                <option value="percent">Percent</option>
                <option value="amount">Amount</option>
              </select>
            </label>
            <label>
              <span>Global discount value</span>
              <input
                type="number"
                min="0"
                [(ngModel)]="draftFinancial.globalDiscountValue"
              />
            </label>
            <label>
              <span>Customer reference</span>
              <input
                type="text"
                [(ngModel)]="draftFinancial.customerReference"
              />
            </label>
            <label>
              <span>Total discount</span>
              <input
                type="number"
                min="0"
                [(ngModel)]="draftFinancial.totalDiscount"
              />
            </label>
            <p class="muted">Tracking numbers remain read-only.</p>
          </ng-container>
        </div>

        <footer class="modal-actions">
          <button type="button" class="secondary" (click)="closeEdit()">
            Cancel
          </button>
          <button
            type="button"
            class="primary"
            *ngIf="activeEdit === 'schedule'"
            (click)="saveSchedule()"
          >
            Save schedule
          </button>
          <button
            type="button"
            class="primary"
            *ngIf="activeEdit === 'customer'"
            (click)="saveCustomer()"
          >
            Save customer
          </button>
          <button
            type="button"
            class="primary"
            *ngIf="activeEdit === 'financial'"
            (click)="saveFinancial()"
          >
            Save financials
          </button>
        </footer>
      </div>
    </div>
  </content>
</ui-shell>
